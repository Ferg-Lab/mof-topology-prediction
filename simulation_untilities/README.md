# Free Energy Calculation Utilities

## Compiling LAMMPS

LAMMPS version 22 Jun 2022 ([LAMMPS](https://github.com/lammps/lammps/releases/tag/stable_23Jun2022))

The following additional packages are required:

`make yes-molecule`
`make yes-extra-fix`
`make yes-extra-compute`
`make yes-fep`
`make yes-body`
`make yes-kspace`
`make yes-manybody`
`make yes-rigid`
`make yes-extra-molecule`

Replace the `fix_ti_spring.cpp` in the `LAMMPS/src` folder with the provided one, which is slightly modified for the final non-equi free energy calculation. Finally compile LAMMPS in the src directory.

## CIF generation for free energy calculations

We use ToBaCCo-3.0 code to generate the structures as placed in the [ToBaCCo](https://github.com/tobacco-mofs/tobacco_3.0) folder. Install the python and dependencies as shown in the README.md file in ToBaCCo. You may create a separate conda environment for tobbaco.

Note that the codes are slightly modified so that it does not rescale charges as we want to keep charges in the frameworks. The generated cifs would be placed in the output_cifs folder. Searching all templates could be quite intensive, you can select certain templates for your purposes. Simply run `python tobacco.py` would do the trick.

## Free energy calculation Workflow example
The workflow includes four folders: 001_data_preparation, 002_deposit_cations, 003_TI_workflow, 004_post-processing_tools

### 001_data_preparation

The cifs folder includes hypothetical MOFs generated by ToBaCCo code. The [cifs2lammps](https://github.com/rytheranderson/cif2lammps.git) is taken from Ryther Anderson et al. developed for parameterizing ToBaCCo MOFs with UUF, UFF4MOF and other universal FF. 

Simply run `python main_conversion.py --cifs ../cifs --outdir ../data` will parameterize the MOFs and put the data files into the data directory. 

We will need different coefficient settings in different TI steps, so all the data files are processed to remove the section between Masses and Atoms. The coefficients are listed separately as shown in folder 002_TI_workflow. In addition, the atom types, bond types, angle types, dihedral types and improper styles should be modified to include the types from the cations to insert. To do this, change dir_path as well as the types in data_processing.sh and then run the bash scripts.

### 002_deposit_cations

Then we can use the original data files to put cations into the frameworks. The `in.deposit` are the scripts to deposit cations and optimize structures. 

We can then copy the folders containing each data to this folder, and then modify `deposit.sh` to automate the cation deposition and energy minimization process. 

The `in.potential` and `in.strain` are used to extract the potential energy at 300K and 0K for preliminary ranking. 

### 003_TI_workflow

After optimizing the structures, we can move the optimized structure to here and then run the TI for each step. One can essentially run the simulation separately for each step in parallel or run each step sequentially. It depends on your preference. Then change the dirs in `TI.sh` and then run the scripts. It will loop over the directories and then run the simulations sequentially. 

### 004_post-processing-tools

This folder basically includes all the data analysis tools to integrate the results. You can copy the folder integrate tools to the directory containing of all completed structures and run the `analysis-xxx.sh` separately. It will output integrated free energies into `xxx.dat` files.

For the final step, we used a non-equilibrium method to estimate the free energy of removing the restraints. The `integrate_hr.ipynb` and `corrections.ipynb` notebooks are used to integrate this and calculate the COM corrections, respectively.

### Others

tThe ZEO++ is used to calculate MOF geometric properties. It requires cif format as inputs thus we can convert the lammps data file to cif files using ASE, which is done using `lmp2cifs.ipynb`.



