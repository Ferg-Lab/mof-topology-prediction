
# Free Energy Calculation Utilities

## Compile LAMMPS

LAMMPS version 22 Jun 2022 ([LAMMPS](https://github.com/lammps/lammps/releases/tag/stable_23Jun2022))

The following additional packages are required:

- `make yes-molecule`
- `make yes-extra-fix`
- `make yes-extra-compute`
- `make yes-fep`
- `make yes-body`
- `make yes-kspace`
- `make yes-manybody`
- `make yes-rigid`
- `make yes-extra-molecule`

Replace the `fix_ti_spring.cpp` in the `LAMMPS/src` folder with the provided one, which is slightly modified for the final non-equilibrium free energy calculation. Finally, compile LAMMPS in the `src` directory.

## CIF Generation for Free Energy Calculations

We use the ToBaCCo-3.0 code to generate the structures, which are placed in the [ToBaCCo](https://github.com/tobacco-mofs/tobacco_3.0) folder. Install Python and dependencies as shown in the `README.md` file in ToBaCCo. You may create a separate conda environment for ToBaCCo.

Note that the codes are slightly modified so that they do not rescale charges, as we want to keep charges in the frameworks. The generated CIFs will be placed in the `output_cifs` folder. Searching all templates could be quite intensive, so you can select certain templates for your purposes. Simply running `python tobacco.py` will do the trick.

## Free Energy Calculation Workflow Example

The workflow includes four folders: `001_data_preparation`, `002_deposit_cations`, `003_TI_workflow`, `004_post-processing_tools`.

### 001_data_preparation

The `cifs` folder includes hypothetical MOFs generated by the ToBaCCo code. The [cifs2lammps](https://github.com/rytheranderson/cif2lammps.git) tool, developed by Ryther Anderson et al., is used for parameterizing ToBaCCo MOFs with UFF, UFF4MOF, and other general force fields.

Simply run `python main_conversion.py --cifs ../cifs --outdir ../data` to parameterize the MOFs and place the data files into the `data` directory.

We will need different coefficient settings for different TI steps, so all the data files are processed to remove the section between Masses and Atoms. The coefficients are listed separately, as shown in the `002_TI_workflow` folder. Additionally, the atom types, bond types, angle types, dihedral types, and improper styles should be modified to include the types from the cations to be inserted. To do this, change `dir_path` as well as the types in `data_processing.sh` and then run the bash scripts.

### 002_deposit_cations

Next, we can use the original data files to insert cations into the frameworks. The `in.deposit` scripts are used to deposit cations and optimize structures.

We can then copy the folders containing each data set to this folder and modify `deposit.sh` to automate the cation deposition and energy minimization process.

The `in.potential` and `in.strain` scripts are used to extract the potential energy at 300 K and 0 K for preliminary ranking.

### 003_TI_workflow

After optimizing the structures, we can move the optimized structures here and then run the TI for each step. You can either run the simulation separately for each step in parallel or run each step sequentially, depending on your preference. Then, change the directories in `TI.sh` and run the scripts. It will loop over the directories and run the simulations sequentially.

### 004_post-processing_tools

This folder includes all the data analysis tools to integrate the results. You can copy the integration tools to the directory containing all completed structures and run the `analysis-xxx.sh` scripts separately. It will output integrated free energies into `xxx.dat` files.

For the final step, we used a non-equilibrium method to estimate the free energy of removing the restraints. The `integrate_hr.ipynb` and `corrections.ipynb` notebooks are used to integrate this and calculate the COM corrections, respectively.

### Others

The ZEO++ is used to calculate MOF geometric properties. It requires CIF format as inputs; thus, we can convert the LAMMPS data file to CIF files using ASE, which is done using `lmp2cifs.ipynb`.
